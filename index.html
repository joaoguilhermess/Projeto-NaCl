<!DOCTYPE html>
<html>
<head>
	<title>Projeto NaCl</title>
	<meta charset="UTF-8">
	<style type="text/css">
		@font-face {
			font-family: "Whitney";
			font-style: normal;
			text-rendering: optimizeLegibility;
			src: local("Whitney Medium"), url("whitneymedium") format("woff");
		}
		* {
			box-sizing: content-box;
			transition-duration: 0.5s;
			user-select: none;
		}	
		::-webkit-scrollbar {
			width: 0.5em;
			height: 0.5em;
			background: #181818;
		}
		::-webkit-scrollbar-thumb {
			transition-duration: 0.5s;
			background: #353535;
		}
		::-webkit-scrollbar-thumb:hover {
			transition-duration: 0.5s;
			background: #808080;
		}
		html, body {
			font-size: 14px;
			font-weight: 500;
			color: #f0f0f0;
			font-family: Whitney, Roboto;
			min-height: 100vh;
			min-width: 100vw;
			margin: 0;
			padding: 0;
		}
		body {
			background-color: #181818;
		}
		input {
			border-top: 0;
			border-left: 0;
			border-right: 0;
			padding: 0.5em;
			padding-left: 1em;
			padding-right: 1em;
		}
		.chat {
			display: flex;
			position: fixed;
			flex-direction: column;
			width: 100%;
			height: 100%;
		}
		header, main, footer {
			display: flex;
			width: 100%;
			padding: 1em;
			align-items: center;
			justify-content: center;
		}
		header {
			flex: 0.05;
			max-height: 10%;
		}
		main {	
			display: flex;
			max-height: 80%;
			background: #202020;
			flex: 0.9;
		}
		main .left {
			display: flex;
			flex-direction: column;
			justify-content: space-between;
			text-align: center;
			flex: 0.20;
		}
		main .left .title {
			flex: 0.5;
			width: 100%;
			margin-top: 25%;
			margin-bottom: 25%;
		}
		main .right {
			max-height: 100%;
			overflow-y: auto;
			flex-wrap: nowrap;
			flex-direction: row;
			flex: 0.80;
		}
		main .right .rooms {
			max-height: 100%;
			overflow-y: auto;
			flex-wrap: nowrap;
			flex-direction: row;
			flex: 0.80;
		}
		main .right .rooms .room {
			display: flex;
			flex-direction: column;
			color: #909090;
			/* flex: 1 0 auto; */
			padding: 0.5em;
			height: 10em;
			max-height: 10em;
			overflow-y: hidden;
			background-color: #222222;
			border-bottom-style: solid;
			border-bottom-width: 1.5px;
			border-bottom-color: #353535;
		}
		main .right .rooms .room .header {
			display: flex;
			justify-content: space-between;
		}
		main .right .rooms .room .name {
			padding: 0.5em;
		}
		main .right .rooms .room:hover .name {
			color: #f0f0f0;
		}
		main .right .rooms .room .description {
			color: #606060;
			padding: 0.75em;
		}
		main .right .rooms .room .join {
			cursor: pointer;
			background: transparent;
			color: #909090;
			
			border-bottom-style: solid;
			border-bottom-width: 1.5px;
			border-bottom-color: #252525;
		}
		main .right .rooms .room .join:hover {
			border-bottom-color: #f00000;
			color: #ffffffd0;
		}
		main .right .rooms .room:hover .description {
			color: #808080;
		}
		main .right .rooms .room:active {
			max-height: none;
			height: 100%;
		}
		footer {
			flex: 0.05;
			max-height: 10%;
			display: flex;
			align-items: flex-end;
			flex-direction: row;
		}
		footer .left {
			flex: 0.25;
			max-width: 24%;
			display: flex;
			height: 100%;
			align-items: flex-end;
		}
		footer .left .user {
			display: flex;
			border-bottom-style: solid;
			border-bottom-width: 1.5px;
			border-bottom-color: #f00f0f;
		}
		footer .left .user .name {
			color: #f0f0f0;
		}
		footer .left .user .id {
			font-size: 14px;
			color: #606060;
			margin-left: 0.25em;
		}
		footer .middle {
			flex: 0.50;
			max-width: 52%;
			display: flex;
			padding-left: 0.5em;
			padding-right: 0.5em;
			justify-content: center;
			align-items: center;
			margin-left: auto;
			margin-right: auto;
		}
		footer .middle .type {
			display: flex;
			align-items: center;
			width: 100%;
		}
		footer .middle .type:focus:hover, footer .middle .type:focus{
			border-bottom-color: #ff0000;
		}
		footer .middle .type:hover {
			border-bottom-color: #606060;
		}
		footer .middle .type::placeholder {
			font-family: Whitney;
			transition-duration: 0.5s;
			color: #707070;
		}
		footer .middle .type:focus::placeholder, footer .middle .type:hover::placeholder {
			color: #a0a0a0;
		}
		footer .middle .type input {
			font-family: Whitney;
			outline: 0;
			width: 100%;
			transition-duration: 0.5s;
			border-top-right-radius: 5%;
			border-top-left-radius: 5%;
			border-bottom-style: solid;
			border-bottom-width: 1.5px;
			border-bottom-color: #353535;
			color: #ffffffd0;
			background: #25252570;
		}
		footer .right {
			flex: 0.25;
			max-width: 24%;
			display: flex;
		}
		footer .right .key {	
			display: flex;
			overflow-x: auto;
		}
		footer .right .key .title {
			color: #808080;
		}
		footer .right .key .content {
			margin-left: 0.25em;
			color: #606060;
		}
	</style>
</head>
<body>
	<section class="chat">
		<header>
			<span>Projeto NaCl</span>
		</header>
		<main>
			<div class="left">
				<div class="title create">Create room</div>
				<div class="title chose">Chose room</div>
			</div>
			<div class="right">
				<div class="rooms"></div>
			</div>
		</main>
		<footer>
			<div class="left">
				<div class="user">
					<div class="name"></div>
					<div class="id"></div>
				</div>
			</div>
			<div class="middle">
				<div class="type">
					<input type="text" placeholder="type on me">
				</div>
			</div>
			<div class="right">
				<div class="key">
					<div class="title">PublicKey</div>
					<div class="content"></div>
				</div>
			</div>
		</footer>
	</section>
</body>
	<script type="text/javascript" src="socket.io/socket.io.js"></script>
	<script type="text/javascript" src="nacl.js"></script>
	<script type="text/javascript" src="nacl-util.js"></script>
	<script type="text/javascript">
		const lorem = "Lorem ipsum dolor sit amet. Ut dolores galisum et maxime minus in dolorem velit.\
		Et natus minima ut porro sequi et temporibus dolorum vel nemo placeat. Aut molestiae sunt qui n\
		atus consequatur qui vero omnis a Quis enim sit repellat quisquam hic similique accusamus eos q\
		uam ipsam. Aut voluptatem temporibus sed deserunt omnis est alias asperiores ad voluptas volupt\
		atem est amet voluptatem et unde consequatur sit accusamus vero. Et laudantium doloremque aut i\
		ncidunt sequi vel inventore Quis ea esse internos. Aut deserunt beatae quo rerum dignissimos es\
		t facilis consequuntur ab voluptatem consequuntur qui voluptatum aliquid. Et fuga dolor qui ips\
		a galisum vel perspiciatis illum aut voluptas molestiae. Sit nisi magnam aut consequatur nemo e\
		st atque quisquam.";

		const header = document.querySelector("header");
		const main = document.querySelector("main");
		const footer = document.querySelector("footer");
		const chatSection = document.querySelector(".chat");
		const createRoomDiv = document.querySelector("main .left .create");
		const choseRoomDiv = document.querySelector("main .left .chose");
		const roomsContainer = document.querySelector(".rooms");
		const userContainer = document.querySelector(".user");
		const userNameDiv = document.querySelector(".user .name");
		const useridDiv = document.querySelector(".user .id");
		const inputContainer = document.querySelector(".type");
		const inputDiv = document.querySelector(".type input");
		const keyContainer = document.querySelector(".key");
		const keyTitleDiv = document.querySelector(".key .title");
		const keyContentDiv = document.querySelector(".key .content");

		onkeypress = function(event) {
			if (event.key == "+") {
				createRoom("Room " + (roomsContainer.children.length + 1), lorem, null);
			} else if (event.key == "-") {
				removeRoom();
			}
		}
		createRoomDiv.onclick = function(event) {
			
		}
		choseRoomDiv.onclick = function(event) {

		}

		function createRoom(name, description) {
			console.log("Create Room: " + name, "Description: " + description);
			socket.emit("create", function(result) {
				result = JSON.parse(decrypt(result, serverKey));
				console.log("Create result: " + JSON.stringify(result));
			
				var room = document.createElement("div");
				var roomHeader = document.createElement("div");
				var roomName = document.createElement("div");
				var roomDescription = document.createElement("div");
				var joinButton = document.createElement("input");
				
				room.classList.add("room");
				roomHeader.classList.add("header");
				roomName.classList.add("name"); 
				roomDescription.classList.add("description");
				joinButton.classList.add("join");
				room.append(roomHeader);
				room.header = roomHeader;
				
				room.id = result.roomId;

				room.header.append(roomName);
				room.name = roomName;
				room.name.textContent = name;

				room.header.append(joinButton);
				room.join = joinButton;
				room.join.type = "submit";
				room.join.value = "Join";
				room.join.onclick = function(event) {
					console.log("Click: ", room);
				}

				room.append(roomDescription);
				room.description = roomDescription;
				room.description.textContent = description;

				rooms[room.id] = room;

				roomsContainer.append(room);

				});
			// return room;
		}

		function removeRoom(id) {
			console.log("Create Room: " + id);
			if (id) {
				try {
					delete rooms[id];
				} catch {}
			} else {
				roomsContainer.children[roomsContainer.children.length - 1].remove();
			}
		}

		function encrypt(message, key) {
			console.log("Encrypt: " + message, "Key: " + key);
			try {
				var nonce = nacl.randomBytes(nacl.box.nonceLength);
				var array = nacl.util.decodeUTF8(message);
				var encrypted = nacl.box(array, nonce, key, keys.secretKey);
				var content = new Uint8Array(nonce.length + encrypted.length);
				content.set(nonce);
				content.set(encrypted, nonce.length);
				return nacl.util.encodeBase64(content);
			} catch (e) {
				console.error(`encrypt(${message}, ${key}); Error: ${e}`);
			}
		}

		function decrypt(message, key) {
			console.log("Decrypt: " + message, "Key: " + key);
			try {
				var array = nacl.util.decodeBase64(message);
				var nonce = array.slice(0, nacl.box.nonceLength);
				var content = array.slice(nacl.box.nonceLength, array.length);
				var decrypted = nacl.box.open(content, nonce, key, keys.secretKey);
				return nacl.util.encodeUTF8(decrypted);
			} catch (e) {
				console.error(`decrypt(${message}, ${key}); Error: ${e}`);
			}
		}

		const keys = nacl.box.keyPair();

		keyContentDiv.textContent = nacl.util.encodeBase64(keys.publicKey);

		const socket = io.connect();

		var rooms = {};

		const myname = "BANBAN";

		var serverKey;
		var messageNonce;
		var clientId;
		socket.emit("serverKey", function(key) {
			console.log("Server Key: " + key);
			serverKey = nacl.util.decodeBase64(key);
			console.log("Server Key: ", serverKey);
			console.log("Client Key: ", keys.publicKey);
			
			socket.emit("login", encrypt(myname, serverKey), nacl.util.encodeBase64(keys.publicKey), function(nonce, id) {
				console.log("Login: " + myname, "Key: " + keys.publicKey);
				messageNonce = decrypt(nonce, serverKey);
				clientId = decrypt(id, serverKey);
				userNameDiv.textContent = myname;
				useridDiv.textContent = "#" + clientId;
			});
		});

		socket.on("publickey", function(id, key) {

		});
		socket.on("ask", function(room, id) {
			
		});
		socket.on("join", function(room, id) {
			
		});
		socket.on("message", function(room, id, message) {
			
		});
		socket.on("read", function(room, id, message) {
			
		});
		socket.on("leave", function(room, id) {
			
		});
	</script>

</html>